{% extends 'base.html' %}
{% load buttons %}
{% load helpers %}
{% load static %}


{% block extra_styles %}
<style>
    .btn-filter-value {
        background: #cfcfcf;
        margin-right: 5px;
    }
</style>
{% endblock extra_styles %}

{% block content %}
<div class="pull-right noprint">
    {% block buttons %}{% endblock %}
    {% if request.user.is_authenticated and table_config_form %}
        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#ObjectTable_config" title="Configure table"><i class="mdi mdi-cog"></i> Configure</button>
    {% endif %}
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#DynamicFilterForm_modal" title="Add filters"><i class="mdi mdi-filter"></i> Filter</button>
    {% if permissions.add and 'add' in action_buttons %}
        {% add_button content_type.model_class|validated_viewname:"add" %}
    {% endif %}
    {% if permissions.add and 'import' in action_buttons %}
        {% import_button content_type.model_class|validated_viewname:"import" %}
    {% endif %}
    {% if 'export' in action_buttons %}
        {% export_button content_type %}
    {% endif %}
</div>
<h1>{% block title %}{{ content_type.model_class|meta:"verbose_name_plural"|bettertitle }}{% endblock %}</h1>
{% if filter_params %}
<div class="filters-applied">
    Filters:
    {% for field, values in filter_params %}
        <button class="btn btn-sm">
            <b>{{ field }}:</b>
            {% for value in values %}
                <span class="btn btn-sm btn-filter-value">
                    <i
                        class="mdi mdi-close text-danger remove-filter-param"
                        data-field-type="child"
                        data-field-parent={{ field }}
                        data-field-value={{ value }}
                    ></i> {{ value }}
                </span>
            {% endfor %}
            <b class="text-danger">
                <i
                    class="mdi mdi-close remove-filter-param"
                    data-field-type="parent"
                    data-field-value={{ field }}
                ></i>
            </b>
        </button>
    {% endfor %}
</div>
<hr>
{% endif %}

<div class="row">
    <div class="col-md-12">
        {% with bulk_edit_url=content_type.model_class|validated_viewname:"bulk_edit" bulk_delete_url=content_type.model_class|validated_viewname:"bulk_delete" %}
        {% if permissions.change or permissions.delete %}
            <form method="post" class="form form-horizontal">
                {% csrf_token %}
                <input type="hidden" name="return_url" value="{% if return_url %}{{ return_url }}{% else %}{{ request.path }}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}{% endif %}" />
                {% if table.paginator.num_pages > 1 %}
                <div class="table-responsive">
                    <div id="select_all_box" class="hidden panel panel-default noprint">
                        <div class="panel-body">
                            <div class="checkbox-inline">
                                <label for="select_all">
                                    <input type="checkbox" id="select_all" name="_all" />
                                    Select <strong>all {{ table.rows|length }} {{ table.data.verbose_name_plural }}</strong> matching query
                                </label>
                            </div>
                            <div class="pull-right">
                                {% if bulk_edit_url and permissions.change %}
                                    <button type="submit" name="_edit" formaction="{% url bulk_edit_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-warning btn-sm" disabled="disabled">
                                        <span class="mdi mdi-pencil" aria-hidden="true"></span> Edit All
                                    </button>
                                {% endif %}
                                {% if bulk_delete_url and permissions.delete %}
                                    <button type="submit" name="_delete" formaction="{% url bulk_delete_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-danger btn-sm" disabled="disabled">
                                        <span class="mdi mdi-trash-can-outline" aria-hidden="true"></span> Delete All
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% include table_template|default:'responsive_table.html' %}
                <div class="pull-left noprint">
                    {% block bulk_buttons %}{% endblock %}
                    {% if bulk_edit_url and permissions.change %}
                        <button type="submit" name="_edit" formaction="{% url bulk_edit_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-warning btn-sm">
                            <span class="mdi mdi-pencil" aria-hidden="true"></span> Edit Selected
                        </button>
                    {% endif %}
                    {% if bulk_delete_url and permissions.delete %}
                        <button type="submit" name="_delete" formaction="{% url bulk_delete_url %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-danger btn-sm">
                            <span class="mdi mdi-trash-can-outline" aria-hidden="true"></span> Delete Selected
                        </button>
                    {% endif %}
                </div>
            </form>
        {% else %}
            {% include table_template|default:'responsive_table.html' %}
        {% endif %}
        {% endwith %}
        {% include 'inc/paginator.html' with paginator=table.paginator page=table.page %}
        <div class="clearfix"></div>
    </div>
</div>
{% table_config_form table table_name="ObjectTable" %}
{% dynamic_filter_form_modal filter_form %}
{% endblock %}

{% block javascript %}
<script src="{% static 'js/tableconfig.js' %}"></script>
<script src="{% static 'jquery/jquery.formset.js' %}"></script>
<script>
    $('.formset_row-dynamic-filterform').formset({
        addText: '<span class="mdi mdi-plus-thick" aria-hidden="true"></span> Add another Filter',
        addCssClass: 'btn btn-primary add-row',
        deleteText: '<span class="mdi mdi-trash-can-outline" aria-hidden="true"></span>',
        deleteCssClass: 'btn btn-danger delete-row',
        prefix: 'form',
        formCssClass: 'dynamic-filterform',
        added: jsify_form
    });

    // Remove applied filters
    $(".remove-filter-param").on("click", function(){
        let query_params = location.search
        let type = $(this).attr("data-field-type")
        let field_value = $(this).attr("data-field-value")
        let query_string = location.search.substr(1).split("&")

        if (type === "parent")
            query_string = query_string.filter(item => item.search(field_value) < 0)
        else {
            let parent = $(this).attr("data-field-parent")
            query_string = query_string.filter(item => item.search(parent + "=" + field_value) < 0)
        }
        location.replace("?" + query_string.join("&"))
    })

    // On submit of filter form convert filterform data to a better URL query sting
    // e.g from -->
    //      form-TOTAL_FORMS=4&form-INITIAL_FORMS=0&form-MIN_NUM_FORMS=&form-MAX_NUM_FORMS=&form-0-lookup_field=status&
    //      form-0-lookup_type=status&form-0-lookup_value=active&form-0-lookup_value=decommissioning&
    // to -->
    //      status=active&status=decommissioning

    $("#dynamic-filter-form").on("submit", function(e){
        e.preventDefault()

        fields_data = $(this).serialize().split(/form-\d-lookup_field=\w+&/).slice(1)
        query_fields = []

        fields_data.forEach(field => {
            let lookup_type = field.match(/\w+(?=&)/)
            let lookup_values = `${field}&`.match(/(?<=form-\d+-lookup_value=).+?(?=&)/g)
            let is_field_deleted = /DELETE=on/.test(field)
            if (lookup_values && !is_field_deleted)
                lookup_values.forEach(value => query_fields.push(`${lookup_type}=${value}`))
        })
        location.replace("?" + query_fields.join("&"))
    })

    // Clear new filter values upon creation
    $(".dynamic-filterform-add .add-row").click(function(){
        let new_fields_parent_element = $(".dynamic-filterform").last()
        let lookup_field_classes = [".lookup_field-select", ".lookup_type-select", ".lookup_value-input"]
        lookup_field_classes.forEach(field_class => {
            let element = new_fields_parent_element.find(field_class)
            element.val(null).trigger('change')
        })
        // reinitialize jsify_form
        jsify_form($(document))
    })

</script>
{% endblock %}
